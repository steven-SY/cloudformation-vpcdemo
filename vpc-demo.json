
{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "AWS Training - VPCDemo template",

  "Parameters" : {
		"KeyName" : {
			"Description" : "Key Pair used to launch the NAT instance.",
			"Type" : "String",
			"Default" : "mykey",
			"MinLength": "1",
      "MaxLength": "64",
      "AllowedPattern" : "[-_ a-zA-Z0-9]*",
      "ConstraintDescription" : "Can contain only alphanumeric characters, spaces, dashes and underscores"
		},
		"NatInstanceType" : {
      "Type" : "String",
      "Default" : "t1.micro",
      "Description" : "EC2 instance type for the NAT instance , e.g. m1.small, m1.large, etc. Note: Instance rates apply.",
			"AllowedValues" : ["t1.micro", "m1.small", "m1.medium", "m1.large", "m1.xlarge", "m2.xlarge", "m2.2xlarge", "m2.4xlarge", "c1.medium", "c1.xlarge"],
    	"ConstraintDescription" : "Must be a valid EC2 NAT instance type."
    },
		"VpcIpCidrBlock" : {
			"Type" : "String",
			"Default" : "10.170.0.0/16",
			"Description" : "The IP CIDR block for the VPC."
		},
		"PublicSubnetIpCidrBlock1" : {
			"Type" : "String",
			"Default" : "10.170.1.0/24",
			"Description" : "The IP CIDR block for the 1st public subnet."
		},
		"PublicSubnetIpCidrBlock2" : {
			"Type" : "String",
			"Default" : "10.170.2.0/24",
			"Description" : "The IP CIDR block for the 2nd public subnet."
		},
		"PrivateSubnetIpCidrBlock1" : {
			"Type" : "String",
			"Default" : "10.170.64.0/22",
			"Description" : "The IP CIDR block for the 1st private subnet."
		},
		"PrivateSubnetIpCidrBlock2" : {
			"Type" : "String",
			"Default" : "10.170.128.0/22",
			"Description" : "The IP CIDR block for the 2nd private subnet."
		}
  },

  "Mappings" : {
		"AWSInstanceType2Arch" : {
	  	"t1.micro"    : { "Arch" : "64" },
      "m1.small"    : { "Arch" : "64" },
      "m1.medium"   : { "Arch" : "64" },
      "m1.large"    : { "Arch" : "64" },
      "m1.xlarge"   : { "Arch" : "64" },
      "m2.xlarge"   : { "Arch" : "64" },
      "m2.2xlarge"  : { "Arch" : "64" },
      "m2.4xlarge"  : { "Arch" : "64" },
      "c1.medium" 	: { "Arch" : "64" },
      "c1.xlarge" 	: { "Arch" : "64" }
    },
    "AWSRegionArch2AMI" : {
      "us-east-1"      : { "64" : "ami-c6699baf" },
      "us-west-1"      : { "64" : "ami-3bcc9e7e" },
      "us-west-2"      : { "64" : "ami-52ff7262" },
      "eu-west-1"      : { "64" : "ami-0b5b6c7f" },
      "sa-east-1"      : { "64" : "ami-0039e61d" },
      "ap-southeast-1" : { "64" : "ami-02eb9350" },
      "ap-southeast-2" : { "64" : "ami-39d3be03" }
    },
    "Region2AZ" : {
      "us-west-1" : { "AZ1" : "us-west-1a", "AZ2" : "us-west-1b" },
      "us-east-1" : { "AZ1" : "us-east-1a", "AZ2" : "us-east-1b", "AZ3" : "us-east-1c" },
      "eu-west-1" : { "AZ1" : "eu-west-1a", "AZ2" : "eu-west-1b"},
      "ap-southeast-2" : { "AZ1" : "ap-southeast-2a", "AZ2" : "ap-southeast-2b"}
    }
  },

  "Resources" : {
	  "VPCDemo" : {
      "Type" : "AWS::EC2::VPC",
      "Properties" : {
        "CidrBlock" : { "Ref" : "VpcIpCidrBlock" },
        "EnableDnsSupport" : true,
        "EnableDnsHostnames" : false,
        "InstanceTenancy" : "default",
        "Tags" : [
        	{"Key" : "Name", "Value": "VPCDemo"},
          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} }
        ]
      }
    },

		"PublicSubnet1" : {
	      "Type" : "AWS::EC2::Subnet",
	      "Properties" : {
	        "VpcId" : { "Ref" : "VPCDemo" },
					"CidrBlock" : { "Ref" : "PublicSubnetIpCidrBlock1" },
					"AvailabilityZone" : {"Fn::FindInMap" : [ "Region2AZ", { "Ref" : "AWS::Region" }, "AZ1"] },
	        "Tags" : [
	        	{"Key" : "Name", "Value" : "PublicSubnet1"},
	          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
	          {"Key" : "Network", "Value" : "Public" }
	        ]
	      }
	    },

			"InternetGateway" : {
	      "Type" : "AWS::EC2::InternetGateway",
	      "Properties" : {
	        "Tags" : [
	        	{"Key" : "Name", "Value" : "InternetGateway"},
	          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} }
	        ]
	      }
	    },

	    "AttachGateway" : {
	       "Type" : "AWS::EC2::VPCGatewayAttachment",
	       "Properties" : {
	         "VpcId" : { "Ref" : "VPCDemo" },
	         "InternetGatewayId" : { "Ref" : "InternetGateway" }
	       }
	    },

	    "PublicRouteTable1" : {
	      "Type" : "AWS::EC2::RouteTable",
	      "Properties" : {
	        "VpcId" : {"Ref" : "VPCDemo"},
	        "Tags" : [
	        	{"Key" : "Name", "Value" : "PublicRouteTable1"},
	          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
	          {"Key" : "Network", "Value" : "Public" }
	        ]
	      }
	    },

	    "PublicRoute1" : {
	      "Type" : "AWS::EC2::Route",
	      "Properties" : {
	        "RouteTableId" : { "Ref" : "PublicRouteTable1" },
	        "DestinationCidrBlock" : "0.0.0.0/0",
	        "GatewayId" : { "Ref" : "InternetGateway" }
	      }
	    },

	    "PublicSubnetRouteTableAssociation1" : {
	      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
	      "Properties" : {
	        "SubnetId" : { "Ref" : "PublicSubnet1" },
	        "RouteTableId" : { "Ref" : "PublicRouteTable1" }
	      }
	    },

	    "PublicNetworkAcl" : {
	      "Type" : "AWS::EC2::NetworkAcl",
	      "Properties" : {
	        "VpcId" : {"Ref" : "VPCDemo"},
	        "Tags" : [
	        	{"Key" : "Name", "Value" : "PublicNetworkAcl"},
	          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
	          {"Key" : "Network", "Value" : "Public" }
	        ]
	      }
	    },

	    "InboundPublicNetworkAclEntry" : {
	      "Type" : "AWS::EC2::NetworkAclEntry",
	      "Properties" : {
	        "NetworkAclId" : {"Ref" : "PublicNetworkAcl"},
	        "RuleNumber" : "100",
	        "Protocol" : "6",
	        "RuleAction" : "allow",
	        "Egress" : "false",
	        "CidrBlock" : "0.0.0.0/0",
	        "PortRange" : {"From" : "0", "To" : "65535"}
	      }
	    },

	    "OutBoundPublicNetworkAclEntry" : {
	      "Type" : "AWS::EC2::NetworkAclEntry",
	      "Properties" : {
	        "NetworkAclId" : {"Ref" : "PublicNetworkAcl"},
	        "RuleNumber" : "101",
	        "Protocol" : "6",
	        "RuleAction" : "allow",
	        "Egress" : "true",
	        "CidrBlock" : "0.0.0.0/0",
	        "PortRange" : {"From" : "0", "To" : "65535"}
	      }
	    },

	    "PublicSubnetNetworkAclAssociation1" : {
	      "Type" : "AWS::EC2::SubnetNetworkAclAssociation",
	      "Properties" : {
	        "SubnetId" : { "Ref" : "PublicSubnet1" },
	        "NetworkAclId" : { "Ref" : "PublicNetworkAcl" }
	      }
	    },

	    "PrivateSubnet1" : {
	      "Type" : "AWS::EC2::Subnet",
	      "Properties" : {
	        "VpcId" : { "Ref" : "VPCDemo" },
					"CidrBlock" : { "Ref" : "PrivateSubnetIpCidrBlock1" },
					"AvailabilityZone" : {"Fn::FindInMap" : [ "Region2AZ", { "Ref" : "AWS::Region" }, "AZ1" ] },
	        "Tags" : [
	        	{"Key" : "Name", "Value" : "PrivateSubnet1"},
	          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
	          {"Key" : "Network", "Value" : "Private" }
	        ]
	      }
	    },

	    "PrivateRouteTable1" : {
	      "Type" : "AWS::EC2::RouteTable",
	      "Properties" : {
	        "VpcId" : {"Ref" : "VPCDemo"},
	        "Tags" : [
	        	{"Key" : "Name", "Value" : "PrivateRouteTable1"},
	          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
	          {"Key" : "Network", "Value" : "Private" }
	        ]
	      }
	    },

			"PrivateNatRoute1" : {
	      "Type" : "AWS::EC2::Route",
	      "Properties" : {
	        "RouteTableId" : { "Ref" : "PrivateRouteTable1" },
	        "DestinationCidrBlock" : "0.0.0.0/0",
	        "InstanceId" : { "Ref" : "NatInstance1" }
	      }
	    },

	    "PrivateSubnetRouteTableAssociation1" : {
	      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
	      "Properties" : {
	        "SubnetId" : { "Ref" : "PrivateSubnet1" },
	        "RouteTableId" : { "Ref" : "PrivateRouteTable1" }
	      }
	    },

	    "PrivateNetworkAcl" : {
	      "Type" : "AWS::EC2::NetworkAcl",
	      "Properties" : {
	        "VpcId" : {"Ref" : "VPCDemo"},
	        "Tags" : [
	        	{"Key" : "Name", "Value" : "PrivateNetworkAcl"},
	          {"Key" : "Application", "Value" : { "Ref" : "AWS::StackName"} },
	          {"Key" : "Network", "Value" : "Private" }
	        ]
	      }
	    },

	    "InboundPrivateNetworkAclEntry" : {
	      "Type" : "AWS::EC2::NetworkAclEntry",
	      "Properties" : {
	        "NetworkAclId" : {"Ref" : "PrivateNetworkAcl"},
	        "RuleNumber" : "100",
	        "Protocol" : "6",
	        "RuleAction" : "allow",
	        "Egress" : "false",
	        "CidrBlock" : "0.0.0.0/0",
	        "PortRange" : { "From" : "0", "To" : "65535"}
	      }
	    },

	    "OutBoundPrivateNetworkAclEntry" : {
	      "Type" : "AWS::EC2::NetworkAclEntry",
	      "Properties" : {
	        "NetworkAclId" : {"Ref" : "PrivateNetworkAcl"},
	        "RuleNumber" : "100",
	        "Protocol" : "6",
	        "RuleAction" : "allow",
	        "Egress" : "true",
	        "CidrBlock" : "0.0.0.0/0",
	        "PortRange" : {"From" : "0", "To" : "65535"}
	      }
	    },

	    "PrivateSubnetNetworkAclAssociation1" : {
	      "Type" : "AWS::EC2::SubnetNetworkAclAssociation",
	      "Properties" : {
	        "SubnetId" : { "Ref" : "PrivateSubnet1" },
	        "NetworkAclId" : { "Ref" : "PrivateNetworkAcl" }
	      }
	    },

		"NatInstance1" : {
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "KeyName" : { "Ref" : "KeyName" },
        "ImageId" : { "Fn::FindInMap" : [ "AWSRegionArch2AMI", { "Ref" : "AWS::Region" }, { "Fn::FindInMap" : [ "AWSInstanceType2Arch", { "Ref" : "NatInstanceType" }, "Arch" ] } ] },
				"InstanceType" : { "Ref" : "NatInstanceType" },
				"NetworkInterfaces" : [ { "NetworkInterfaceId" : {"Ref" : "NatInstanceInterface1"}, "DeviceIndex" : "0" } ],
				"Tags" : [
					{
						"Key" : "Name",
						"Value" : "NAT Instance1"
					}
				]
      }
    },

		"NatInstanceInterface1" : {
		      "Type" : "AWS::EC2::NetworkInterface",
		      "Properties" : {
		        "SubnetId" : { "Ref" : "PublicSubnet1" },
		        "Description" :"Interface for control traffic such as SSH",
		        "GroupSet" : [ { "Ref" : "NatInstanceSecurityGroup1" } ],
		        "SourceDestCheck" : "false",
		        "Tags" : [ {"Key" : "Network", "Value" : "Control"}]
		      }
		    },

		"NatInstanceIpAddress1" : {
			"Type" : "AWS::EC2::EIP",
			"Properties" : {
				"Domain" : "VPCDemo"
			}
		},

		"AssociateNatInstanceIpAddress1" : {
      "Type" : "AWS::EC2::EIPAssociation",
      "Properties" : {
        "AllocationId" : { "Fn::GetAtt" : [ "NatInstanceIpAddress1", "AllocationId" ]},
        "NetworkInterfaceId" : { "Ref" : "NatInstanceInterface1" }
      }
    },

		"NatInstanceSecurityGroup1" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Enable NAT for instances in private subnets",
				"VpcId" : { "Ref" : "VPCDemo" },
        "SecurityGroupIngress" : [
					{
						"IpProtocol" : "tcp", "FromPort" : "0", "ToPort" : "65535", "CidrIp" : "0.0.0.0/0"
					}
				],
				"SecurityGroupEgress" : [
					{
						"IpProtocol" : "tcp", "FromPort" : "0", "ToPort" : "65535", "CidrIp" : "0.0.0.0/0"
					}
				]
      }
    }
  },

  "Outputs" : {
    "NatInstancePublicIP1" : {
      "Description" : "Public Elastic IP address of the NAT instance1.",
      "Value" : { "Ref" : "NatInstanceIpAddress1" }
    }
  }
}
